var kmn_siteurl=kmn_siteurl||undefined,kmn_tags=kmn_tags||{},kmn_data=kmn_data||{},kmn_placement=kmn_placement||undefined,kmn_size=kmn_size||undefined,kmn_iframe=kmn_iframe||false,kmn_ts=new Date().getTime(),kmn_cb=kmn_cb||Math.floor((kmn_ts%65536)+(Math.floor(Math.random()*65536)*65536));var kmn_sa=kmn_sa||new function(){var e=document.location?("https:"===document.location.protocol):false,d=(e?"https://":"http://"),b=".komoona.com/";this.options={base_url:d+"a"+b,ext_src:d+(e?"a":"cdn")+b+"scripts/kmn",debug:false,ts:[],stat_url:d+"stat"+b+"s",np:d+(e?"a":"s")+b+"passback/np/",v:"2.27",save_stat:[],env:"prod"};this.tagParams={servingEnded:[],statTimer:[],stCount:[],iframeWait:[]};this.statInterval=500;this.stMaxCalls=100;this.iframeMax=6;this.is_iframe=function(){var f=false;try{f=(window.location!==window.parent.location)}catch(g){}return f};var c=this;this.build_js=function(f){return('<script type="text/javascript" src="'+f+'"><\/script>')};this.write_js=function(f){document.write(c.build_js(f))};this.load_js=function(i){try{var f,h=document.createElement("script");h.setAttribute("type","text/javascript");h.setAttribute("src",i);if(typeof h!=="undefined"){f=document.getElementsByTagName("script")[0];f.parentNode.insertBefore(h,f)}}catch(g){c.console("failed loading js! (src="+i+")")}};this.create_iframe=function(j,h,g){var f,i=document.createElement("iframe"),g=g||{};i.setAttribute("src",j);for(f in g){if(g.hasOwnProperty(f)){i.setAttribute(f,g[f])}}i.setAttribute("marginHeight",0);i.setAttribute("marginWidth",0);i.setAttribute("frameBorder",0);i.setAttribute("scrolling","no");if(h){h.appendChild(i)}};this.get_np=function(f){if(typeof(kmn_passbacks)!=="undefined"&&kmn_passbacks.hasOwnProperty(f)){kmn_np.next(f)}else{var g=c.options.np+f+".js";c.write_js(g)}};this.getCurrentDoc=function(){try{return(c.is_iframe()?window.frameElement.contentDocument||window.frameElement.contentWindow.document:document)}catch(f){}return null};this.getSSP=function(f){return(f)?f.charAt(0):null};this.callS2s=function(h,l){var p="",m=c.getDataVar(h,"s2sBaseUrl");if(m){var j={layoutid:h,chain:l.codes,cb:kmn_cb};j.index=l.full_index-1;j.uts=new Date().getTime();j.inFrame=(kmn_sa.is_iframe())?(1):(0);j.url=encodeURIComponent(c.site_url());j.tz=new Date().getTimezoneOffset();var n=c.getCurrentDoc();if(n){var f=n.characterSet?n.characterSet:n.charset;if(f){j.ch=f}}var o=c.getDataVar(h,"etc");if(o){for(var k in o){j["etc."+k]=o[k];c.console("etc param:"+k+"="+o[k])}}var g=kmn_cstat.stat_src(m+"GetAd",j);c.console("calling s2s["+g+"]");p=c.build_js(g)}return p};this.s2sServerIncrement=function(g,l,m){if(l>0){var f=c.getDataVar(g,"full_index"),o=l-1,n=f+o;c.console("s2sSrvInc requests index increment by "+o+", new index="+n);if(o>0){var k=c.getDataVar(g,"order",""),j=c.getDataVar(g,"codes","");c.console("s2sSrvInc: increment > 0, curOrder="+k+", chain="+j);for(var h=f;h<n;h++){k=j[h].split("").reverse().join("")+"|"+k;c.console("adding s2s processed code: index="+h+", code="+j[h])}c.console("setting new order to "+k);c.setDataVar(g,"order",k);c.setDataVar(g,"full_index",n);c.console("incrementing full index by "+o+", new index: "+c.getDataVar(g,"full_index"))}}else{c.console("ERROR: got negative increment: "+l)}};this.useS2sOn=function(g,j){var h=c.getDataVar(g,"s2sCodes");if(h){var i=c.getSSP(j),k=c.getDataVar(g,"s2sExcludedTags"),f=h.indexOf(i)>-1;if(f&&k){f=!(k.indexOf(j)>-1);if(!f){c.console("s2s excluded["+j+"]")}}return f}return false};var a=undefined;this.site_url=function(f){if(f===true&&kmn_siteurl!==undefined){return kmn_siteurl}else{if(!a){a=(c.is_iframe()&&document.referrer!=="")?document.referrer:window.location.href;if(a.indexOf("javascript:window")!==-1){try{a=window.parent.location.href}catch(g){c.console(g.message);a=(c.is_iframe()&&(document.referrer!==""))?document.referrer:window.location.href}}}return a}};this.is_debug=function(){try{var h,k=false,g=window.location.href,f=g.slice(g.indexOf("?")+1).split("&");for(h=0;h<f.length;h++){if(f.hasOwnProperty(h)){if(f[h]==="kmn-debug=true"){k=true}}}c.options.debug=k;if(k&&!window.console){window.console={log:function(){}}}}catch(j){}};this.page_tags=function(h){var g=[];try{for(var f in kmn_tags){if(kmn_tags.hasOwnProperty(f)&&(f!==h)){g.push(f)}}}catch(i){}return g};this.spark=function(g,k){try{var h={tagid:g,v:c.options.v,cb:kmn_cb,ds:document.readyState,ts:c.get_ts(g)};var f=c.page_tags(g);if(f.length){h.p=f.join(";")}if(typeof(k)==="object"){for(var j in k){if(k.hasOwnProperty(j)){h[j]=k[j]}}}c.console("spark["+g+"]data["+c.stringify(h)+"]");kmn_cstat.save(c.options.stat_url,h)}catch(i){}};this.get_ts=function(f){var g=-1;try{if(c.options.ts.hasOwnProperty(f)){g=(new Date().getTime()-c.options.ts[f])}}catch(h){}return g};this.console=function(h){if(c.options.debug){var g=new Date(),f=g.getHours()+":"+g.getMinutes()+":"+g.getSeconds()+":"+g.getMilliseconds();window.console.log("["+f+"] "+h)}};this.direct=function(){var f=c.options.ext_src+"_direct.js";if(document.readyState!=="interactive"&&document.readyState!=="complete"){c.write_js(f)}else{c.load_js(f)}};this.parseSize=function(){var g={w:0,h:0};if(typeof(kmn_size)!=="undefined"){var f=kmn_size.indexOf("x");if(f!==-1){g.w=kmn_size.substring(0,f);g.h=kmn_size.substring(f+1)}}return g};this.initTagParams=function(f){try{if(!Object.prototype.hasOwnProperty){Object.prototype.hasOwnProperty=function(i){var h=obj.__proto__||obj.constructor.prototype;return(i in this)&&(!(i in h)||h[i]!==this[i])}}if(!Array.prototype.indexOf){Array.prototype.indexOf=function(h,i){if(this===undefined||this===null){throw new TypeError('"this" is null or not defined')}var j=this.length>>>0;i=+i||0;if(Math.abs(i)===Infinity){i=0}if(i<0){i+=j;if(i<0){i=0}}for(;i<j;i++){if(this[i]===h){return i}}return -1}}}catch(g){}kmn_tags[f]=1;c.options.ts[f]=kmn_ts;c.tagParams.servingEnded[f]=false;c.tagParams.statTimer[f]=null;c.tagParams.iframeWait[f]=0;c.setStatsTimer(f)};this.replaceTagParams=function(h,g){window.clearInterval(c.tagParams.statTimer[h]);c.switchArrKey(kmn_tags,h,g);c.switchArrKey(c.options.ts,h,g);for(var f in c.tagParams){if(c.tagParams.hasOwnProperty(f)){c.switchArrKey(c.tagParams[f],h,g)}}delete (c.tagParams.stCount[h]);c.switchArrKey(kmn_tags,h,g);c.setStatsTimer(g)};this.switchArrKey=function(f,h,g){if(f.hasOwnProperty(h)){f[g]=f[h];delete f[h]}};this.getWrapperHeight=function(l){var i=-1;try{if(l){var g=("clientHeight" in l)?(l.clientHeight):(0),j=("offsetHeight" in l)?(l.offsetHeight):(0),f=("scrollHeight" in l)?(l.scrollHeight):(0);i=Math.max(j,g,f)}}catch(k){}return i};this.statsParams=function(g){var i={};try{i.l=c.site_url();var j=document.getElementById("kmn_tag_"+g);i.h=c.getWrapperHeight(j);var f=c.page_tags(g);if(f.length){i.p=f.join(";")}if(kmn_siteurl!==undefined){i.um=encodeURIComponent(kmn_siteurl);kmn_siteurl=undefined}i.o=c.getDataVar(g,"order","")}catch(h){c.console("statsParams["+h.message+"]")}return i};this.stats=function(f,g){if(c.tagParams.servingEnded[f]===false){c.tagParams.servingEnded[f]=true;c.console("srv end:tagid["+f+"]o["+g.o+"]h["+g.h+"]");c.spark(f,g)}};this.house=function(f){c.console("house["+f+"]");c.spark(f,{house:true})};this.setStatsTimer=function(f){c.tagParams.stCount[f]=0;c.tagParams.statTimer[f]=window.setInterval(function(){c.statHandler(f)},c.statInterval)};this.statHandler=function(g){if(c.tagParams.servingEnded[g]){window.clearInterval(c.tagParams.statTimer[g])}else{c.tagParams.stCount[g]+=1;var m=c.statsParams(g),f=m.o||"";if(c.tagParams.stCount[g]===c.stMaxCalls){c.spark(g,{o:f,h:m.h,d:c.site_url(),err:"timeout@stats"})}else{if(f.length&&m.h!==-1){if(f.indexOf("h")!==-1){c.stats(g,m)}else{if(m.h>0){var n=document.getElementById("kmn_tag_"+g),l=(n?n.getElementsByTagName("iframe"):[]);if(l.length===0){c.stats(g,m)}else{var h,k=false;for(h=0;h<l.length;h++){k=(l[h].offsetHeight!==0&&l[h].style.display!=="none")||k}if(k){var j=f.split("|");if(j[0].indexOf("x")!==-1){if(c.tagParams.iframeWait[g]<c.iframeMax){c.tagParams.iframeWait[g]+=1}else{c.stats(g,m)}}else{c.stats(g,m)}}else{c.stats(g,m)}}}}}}}};this.cookieSync=function(f,g){if(typeof(kmn_cs)==="undefined"&&typeof(c.options.csLoader)==="undefined"){c.load_js(c.options.ext_src+"-cs.js");c.options.csLoader=window.setInterval(function(){c.cookieSync(f,g)},100)}else{if(typeof(kmn_cs)!=="undefined"){window.clearInterval(c.options.csLoader);kmn_cs.cookieSync(f,g)}}};this.setHeartbeat=function(f){if(typeof(kmn_hb)==="undefined"&&typeof(c.options.hbLoader)==="undefined"){c.load_js(c.options.ext_src+"-hb.js");c.options.hbLoader=window.setInterval(function(){c.setHeartbeat(f)},50)}else{if(typeof(kmn_hb)!=="undefined"){window.clearInterval(c.options.hbLoader);kmn_hb.startHeartbeat(f)}}};this.setS2s=function(f,g,i,h){c.setDataVar(f,"s2sCodes",g);c.setDataVar(f,"s2sBaseUrl",i);if(typeof(h)!=="undefined"){c.setDataVar(f,"s2sExcludedTags",h)}};this.getDataVar=function(g,f,h){if(kmn_data.hasOwnProperty(g)&&kmn_data[g].hasOwnProperty(f)){return kmn_data[g][f]}return h||null};this.setDataVar=function(g,f,i){var h=c.getDataVar(g,f,null);if(!kmn_data.hasOwnProperty(g)){kmn_data[g]={}}kmn_data[g][f]=i;return h};this.tag=function(f){try{c.is_debug();if(typeof(kmn_size)==="undefined"){c.dtag(f)}else{c.stag(f)}}catch(g){c.console("tag["+g.message+"]");c.spark(f,{err:g.message+"@tag"})}};this.dtag=function(f){var l=c.options.base_url,h=c.page_tags(f),k="?l="+encodeURIComponent(c.site_url())+"&v="+c.options.v;if(kmn_siteurl!==undefined){k+="&um="+encodeURIComponent(kmn_siteurl)}if(h.length){k+="&s="+encodeURIComponent(h.join(";"));var j,g=[];for(j in h){if(h.hasOwnProperty(j)){c.console(c.getDataVar(h[j],"codes",""));g.push(c.getDataVar(h[j],"codes",""))}}k+="&codes="+encodeURIComponent(g.join(";"))}if(c.options.debug){k+="&kmn-debug=true"}if(!kmn_tags.hasOwnProperty(f)){c.initTagParams(f);c.spark(f,{d:c.site_url()});l+="tag/"+f+".js"+k}else{kmn_tags[f]+=1;c.spark(f,{err:"duplicate",c:kmn_tags[f],d:c.site_url()});l+="passback/hp/"+f+".js"+k+"&n="+kmn_tags[f]}if(document.readyState!=="complete"&&kmn_iframe!==true){c.console("tag["+l+"]");c.write_js(l)}else{c.atag(f,l)}};this.stag=function(f){var g=c.parseSize();delete kmn_size;c.dtag(f+"_"+g.w+"_"+g.h)};this.atag=function(f,h){var g=c.options.ts.hasOwnProperty(f)?c.options.ts[f]:kmn_ts;h=h.replace(f+".js?",f+".html?")+"&asmmk=true&cb="+kmn_cb+"&ts="+g+"&rd="+document.readyState;c.console("iframe["+h+"]");document.write('<div id="kmn_tag_'+f+'" style="border:none;padding:0;background:transparent;"></div>');c.create_iframe(h,document.getElementById("kmn_tag_"+f),{id:"kmn_iframe_"+f});kmn_iframe=false;komoona_xd.receive(function(i){c.handle(i.data)},c.options.base_url.slice(0,-1))};this.get_xsrc=function(f){var h="";try{h+=f.s+"?cb="+kmn_cb+"&ts="+c.get_ts(f.tid);if(typeof(kmn_data)!=="undefined"&&kmn_data.hasOwnProperty(f.tid)){h+="&t="+kmn_data[f.tid].chain.replace("N","");h+="&codes="+encodeURIComponent(c.stringify(kmn_data[f.tid].codes));h+="&o="+encodeURIComponent(c.getDataVar(f.tid,"order",""));h+="&index="+kmn_data[f.tid].full_index}if(c.options.debug){h+="&kmn-debug=true"}c.tagParams.iframeWait[f.tid]=c.iframeMax;c.tagParams.servingEnded[f.tid]=true;c.console("serving ended (xsrc)["+f.tid+"]xsrc["+h+"]")}catch(g){c.spark(f.tid,{err:g.message+"@xsrc"})}return h};this.handle=function(k){c.console("handle["+k+"]");var f=c.parseJSON(k);if(f!==undefined){if(f.s&&f.tid+f.w+f.h){if(!document.getElementById("kmni_"+f.tid)){var h,l=document.getElementById("kmn_tag_"+f.tid),g=(l?l.getElementsByTagName("ins"):[]);for(h=0;h<g.length;h++){g[h].style.display="none"}c.create_iframe(c.get_xsrc(f),l,{id:"kmni_"+f.tid,width:f.w,height:f.h})}}else{if(+f.h&&f.p){var j=document.getElementById("kmn_iframe_"+f.p);if(j){j.style.display="block";j.setAttribute("width",f.w+"px");j.setAttribute("height",f.h+"px")}c.tagParams.servingEnded[f.p]=true}}}};this.parseJSON=function(g){var f;try{g=g.replace(/^([\s]*)|([\s]*)$/g,"");if(/^[\],:{}\s]*$/.test(g.replace(/\\(?:["\\\/bfnrt]|u[0-9a-fA-F]{4})/g,"@").replace(/"[^"\\\n\r]*"|true|false|null|-?\d+(?:\.\d*)?(?:[eE][+\-]?\d+)?/g,"]").replace(/(?:^|:|,)(?:\s*\[)+/g,""))){f=window.JSON&&window.JSON.parse?window.JSON.parse(g):(new Function("return "+g))()}c.console("json["+g+"]")}catch(h){}return f};this.stringify=function(j){if(window.JSON&&window.JSON.stringify){return window.JSON.stringify(j)}else{var i=typeof(j);if(i!=="object"||j===null){if(i==="string"){j='"'+j+'"'}return String(j)}else{var k,g,h=[],f=(j&&j.constructor===Array);for(k in j){if(j.hasOwnProperty(k)){g=j[k];i=typeof(g);if(i==="string"){g='"'+g+'"'}else{if(i==="object"&&g!==null){g=c.stringify(g)}}h.push((f?"":'"'+k+'":')+String(g))}}return(f?"[":"{")+String(h)+(f?"]":"}")}}}}();var kmn_cstat=kmn_cstat||new function(){function a(c){try{var d,b=document.createElement("script");b.setAttribute("type","text/javascript");b.setAttribute("src",c);b.onerror=function(g){try{kmn_sa.console("src["+b.getAttribute("src")+"]@kmn_cstat.load")}catch(h){}};b.onload=b.onreadystatechange=function(){if(!b.readyState||b.readyState==="loaded"||b.readyState==="complete"){b.onload=b.onreadystatechange=null;if(b&&b.parentNode){b.parentNode.removeChild(b)}}};d=document.getElementsByTagName("head")[0];if(d){d.appendChild(b)}}catch(f){}}this.stat_src=function(b,e){var c,d="?",e=e||{};for(c in e){if(e.hasOwnProperty(c)){d+=encodeURIComponent(c)+"="+encodeURIComponent(e[c])+"&"}}return(b+d.slice(0,-1))};this.save=function(b,d){try{a(kmn_cstat.stat_src(b,d))}catch(c){}}}();var komoona_xd=komoona_xd||(function(){var a=this;return{post:function(b,d,c){if(a.postMessage){c.postMessage(b,d.replace(/([^:]+:\/\/[^\/]+).*/,"$1"))}else{if(d){c.location=d.replace(/#.*$/,"")+"#"+(+new Date)+(cache_bust++)+"&"+b}}},receive:function(d,c){if(a.postMessage){if(d){var b=function(f){if(f.origin!==c&&(typeof f.origin==="string"&&f.origin.indexOf(c)===-1)){return false}return d(f)}}if(a.addEventListener){a[d?"addEventListener":"removeEventListener"]("message",b,false)}else{a[d?"attachEvent":"detachEvent"]("onmessage",b)}}}}}());var json_api=json_api||function(){this.stat=function(a){try{kmn_sa.console("japi["+a+"]")}catch(b){}}};if(kmn_placement!==undefined){var tag=kmn_placement.replace(/^\s\s*/,"").replace(/\s\s*$/,"");delete kmn_placement;kmn_sa.tag(tag)}else{kmn_sa.direct()};